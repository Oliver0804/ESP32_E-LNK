#include "i2c.h"
#include "FT6336.h"
#include <arduino.h>
/*
void delayMicroseconds(unsigned int xus)
{
  for(;xus>1;xus--);
}
*/

 void FT6336_Init(void)
{
	unsigned char temp,KK;
 //IO mode setting

//pinMode(T0, OUTPUT);   //GND
//pinMode(T3, OUTPUT);  //VCC

pinMode(A1, OUTPUT); //RST 
pinMode(A2, OUTPUT); //SCL 
pinMode(A3, OUTPUT); //SDA

//Power setting
//FT6336_PWR();
//FT6336_GND();

//RESET
  FT6336_RST_L();
  delay(50);
 FT6336_RST_H();
	delay(100);
 
	FT6336_SDA_H();
	delay(10);
	FT6336_SCL_H();
	delay(10);
	temp=0;
	FT6336_WR_Reg(FT_DEVIDE_MODE,&temp,1);	//?????????????? 
//	i2c_write_addr_byte(0x38,FT_DEVIDE_MODE,temp);
 	temp=22;								//??????��???22???��?????	
 	FT6336_WR_Reg(FT_ID_G_THGROUP,&temp,1);	//?????????��?
	FT6336_RD_Reg(FT_ID_G_THGROUP,&KK,1);
 	temp=14;								//?????????????��??12?????14
 	FT6336_WR_Reg(FT_ID_G_PERIODACTIVE,&temp,1); 
	FT6336_RD_Reg(FT_ID_G_PERIODACTIVE,&KK,1);


/******************************************************/
}




//-------------------------------????????-----------------------
/****************************************************
* ???????? ??
* ??    ?? ?????????????????
* ?????? ????
* ??????? ????
* ??????? ??
*****************************************************/
void I2C_Start(void)
{
	SDA_OUT();     //sda?????
	FT6336_SDA_H();	  	  
	FT6336_SCL_H();
	delayMicroseconds(10);   //8????,5us????,16????,?????????????,???????8us,????????????10us
 	FT6336_SDA_L();//START:when i2c is high,DATA change form high to low 
	delayMicroseconds(5);
	FT6336_SCL_L();//??I2C???????????????????? 
	delayMicroseconds(10);
}

/****************************************************
* ???????? ??
* ??    ?? ????????????????
* ?????? ????
* ??????? ????
* ??????? ??
*****************************************************/
void I2C_End(void)
{
	SDA_OUT();     		//sda?????
	FT6336_SCL_L();		//SCL??��????????:0.6us		
	FT6336_SDA_L();		
	delayMicroseconds(5);	
	FT6336_SCL_H();		//SCL??��????????:0.6us		
	delayMicroseconds(4);		//????????��???????:0.6us
	FT6336_SDA_H();		//SCL???????SDA??????????????????
	delayMicroseconds(5);	
}


/****************************************************
* ???????? ??
* ??    ?? ?????????????????
* ?????? ????
* ??????? ????
* ??????? ?????????1B????????????????
*****************************************************/
void FT6336_McuACK(void)							
{
	FT6336_SCL_L();
	SDA_OUT();     		//sda?????	
	FT6336_SDA_L();
	delayMicroseconds(5);																	
	FT6336_SCL_H();		//SCL??��????????:0.6us
	delayMicroseconds(10);
	FT6336_SCL_L();	//SCL??��????????:1.2us
	delayMicroseconds(10);
	
	FT6336_SDA_H();
}


/****************************************************
* ???????? ??
* ??    ?? ??????????????????
* ?????? ????
* ??????? ????
* ??????? ???????????????????????????????
*****************************************************/
void FT6336_McuNACK(void)
{
	FT6336_SCL_L();
	SDA_OUT();     				//sda?????	
	FT6336_SDA_H();
	delayMicroseconds(5);																	
	FT6336_SCL_H();				//SCL??��????????:0.6us
	delayMicroseconds(10);
	FT6336_SCL_L();			//SCL??��????????:1.2us
	delayMicroseconds(10);
}

/****************************************************
* ???????? ??
* ??    ?? ??????????FT6236????????????
* ?????? ????
* ??????? ??1????????????
			 0???????????
* ??????? ???????��1?????/???????
			 ??????RevAckF:???FT6236?????????��,?0??????
*****************************************************/
unsigned char FT6336_CheckAck(void)							
{
	unsigned char ucErrTime=0;
	unsigned char redata;
	
	FT6336_SDA_H();
//	delayMicroseconds(50);  
	SDA_IN();  //SDA?????????
	FT6336_SCL_H();			//?SDA????????��;SCL??��????????:0.6us
	delayMicroseconds(10);
	while(Is_SDA_IN != 0)
	{	
		ucErrTime++;
		if(ucErrTime>250)		//?????
		{
			I2C_End();	
			return 1;
		}
	}
	FT6336_SCL_L();
	delayMicroseconds(10);
//	SDA_IN();
//	FT6336_SDA_H();
	return 0;
	
}

/****************************************************
* ???????? ??
* ??    ?? ?????????IIC???????1B????/????
* ?????? ?????????1B???/????
* ??????? ????
* ??????? ?????????????????????????;????????????????
*****************************************************/
void FT6336_WrOneByte(unsigned char dat)						
{
	unsigned char i;						
	SDA_OUT();     				//sda?????	
	FT6336_SCL_L();				//????????????????
	for(i = 0; i < 8; i++)		//8��1B???/????????
	{
		if(dat & 0x80) 		
			FT6336_SDA_H();		//????"1"		
		else
			FT6336_SDA_L();		//????"0"
		
		delayMicroseconds(10);
		FT6336_SCL_H();			//?SDA?????????��
		delayMicroseconds(10);			//SCL??��????????:0.6us							
		FT6336_SCL_L();			//SCL??��????????:1.2us
		delayMicroseconds(10);
		dat <<= 1;				//????????????1��,???��???????	
	}
}

/****************************************************
* ???????? ??
* ??    ?? ?????????IIC???????1B??????
* ?????? ????
* ??????? ???????1B????
* ??????? ?????????????????????????;?????????????????
*****************************************************/
unsigned char FT6336_RdOneByte(void)						
{
	unsigned char i,dat = 0;				//????????��??????????��?

	SDA_IN();						//SDA?????????
	for(i = 0;i < 8;i++)
	{
		FT6336_SCL_L();
		delayMicroseconds(10);
		FT6336_SCL_H();
		delayMicroseconds(10);			//SCL??��????????:1.2us
		dat <<= 1;
		if(Is_SDA_IN != 0)
			dat |= 0x01;
		delayMicroseconds(5);			//SCL??��????????:1.2us
	}
//	delayMicroseconds(2);
//	FT6336_SDA_H();		
	return(dat);				//????1B??????
	
}
/****************************************************
* ??FT6336��?????????
* reg:???????????
* buf:???????????
* len:��???????
* ?????:0,???;1,???.
*****************************************************/
unsigned char FT6336_WR_Reg(unsigned char reg,unsigned char *buf,unsigned char len)
{
	unsigned char i;
	unsigned char ret=0;
	I2C_Start();	 
	FT6336_WrOneByte(FT_CMD_WR);	//????��???? 	 
	FT6336_CheckAck(); 	 										  		   
	FT6336_WrOneByte(reg);   	//?????8��???
	FT6336_CheckAck();  
	for(i=0;i<len;i++)
	{	   
		FT6336_WrOneByte(buf[i]);  	//??????
		ret=FT6336_CheckAck();
		if(ret)break;  
	}
    I2C_End();					//?????????????	    
	return ret; 
	

}
/*****************************************************f
* ??FT6336???????????
* reg:???????????
* buf:???????????
* len:?????????
*****************************************************/
void FT6336_RD_Reg(unsigned char reg,unsigned char *buf,unsigned char len)
{
	unsigned char i; 
 	I2C_Start();	
 	FT6336_WrOneByte(FT_CMD_WR);   	//????��???? 	 
	FT6336_CheckAck(); 	 										  		   
 	FT6336_WrOneByte(reg);   	//?????8��???
	FT6336_CheckAck();  
//  I2C_End();					//?????????????	 
 	I2C_Start();  	 	   
	FT6336_WrOneByte(FT_CMD_RD);   	//?????????		   
	FT6336_CheckAck();	  
	for(i=0;i<(len-1);i++)
	{	   
		buf[i] = FT6336_RdOneByte();		//????1B????????????????????
		FT6336_McuACK();					//???????��	  
	}
	buf[i]  = FT6336_RdOneByte();	
	FT6336_McuNACK();						//n????????,????????��
  I2C_End();					//?????????????	  

} 
 



void FT6336U_start(void)
{
	SDA_OUT();     //sda???
	FT6336_SDA_H();	  	  
	FT6336_SCL_H();
	delayMicroseconds(10);   //8???,5us??,16???,???????,????8us,????????10us
 	FT6336_SDA_L();//START:when i2c is high,DATA change form high to low 
	delayMicroseconds(10);
	FT6336_SCL_L();//??I2C??,????????? 
}

void FT6336U_end(void)
{
	SDA_OUT();//sda???
	FT6336_SCL_L();
	FT6336_SDA_L();//STOP:when i2c is high DATA change form low to high
 	delayMicroseconds(10);
	FT6336_SCL_H(); 
	FT6336_SDA_H();//??I2C??????
	delayMicroseconds(10);							   	
}

void i2c_write_byte(unsigned char txd)
{			   	
	unsigned char t,i2c_sda;   
	SDA_OUT(); 	    
	FT6336_SCL_L();//????????????????
	for(t=0;t<8;t++)
	{              
//		i2c_sda=(txd&0x80)>>7;
 
		if(txd&0x80)
			FT6336_SDA_H();
		else 
			FT6336_SDA_L();
		
		txd<<=1; 	
		
		delayMicroseconds(10);   //??TEA5767?????????????????
		FT6336_SCL_H();
		delayMicroseconds(10); 
		FT6336_SCL_L();	
		delayMicroseconds(10);
	}	      
	FT6336_SDA_H();
	delayMicroseconds(10);
	SDA_IN();	   
	FT6336_SCL_H();
	delayMicroseconds(10);			 
	//	while(Is_SDA_IN);
	for(t=0;t<100;t++)//???100us???
	{
		if(Is_SDA_IN != 0)
			delayMicroseconds(1);
		else
			break;
	}
	FT6336_SCL_L();

	//----------------------------???????--------------------
	if(t >= 100)
	//string_normal(DIS_COL_BOUNDARY+1,UP_START+1,Red,"I2C_NCPL ERROR!");
	;
}

unsigned char i2c_read_byte(void)    //MCU?????
{
	unsigned char i,receive=0;
	
	SDA_IN();//SDA?????????
	for(i=0;i<8;i++ )
	{
		FT6336_SCL_L(); 
		delayMicroseconds(10);
		FT6336_SCL_H();
		receive<<=1;
		if(Is_SDA_IN != 0) 
			receive |= 0x01;   
		delayMicroseconds(10); 
	}					 

	FT6336_SCL_L();
	SDA_OUT();
	FT6336_SDA_H();
	delayMicroseconds(10);
	FT6336_SCL_H();
	delayMicroseconds(10);
	FT6336_SCL_L();

	FT6336_SDA_H();  
	return receive;

}

unsigned char i2c_read_keep_byte(void)    //MCU?????
{
	unsigned char i,receive=0;
	
	SDA_IN();//SDA?????????
	for(i=0;i<8;i++ )
	{
		FT6336_SCL_L(); 
		delayMicroseconds(10);
		FT6336_SCL_H();
		receive<<=1;
		if(Is_SDA_IN != 0) 
			receive |= 0x01;   
		delayMicroseconds(10); 
	}					 

	FT6336_SCL_L();
	SDA_OUT();
	FT6336_SDA_L();
	delayMicroseconds(10);
	FT6336_SCL_H();
	delayMicroseconds(10);
	FT6336_SCL_L();

	FT6336_SDA_H();  
	return receive;
}

unsigned char i2c_read_addr_byte(unsigned char device_addr,unsigned char read_addr)
{
	unsigned char dat;
	FT6336U_start();
	i2c_write_byte(device_addr<<1);
	i2c_write_byte(read_addr);
	FT6336U_end();

	FT6336U_start();
	i2c_write_byte((device_addr<<1) | 0x01);
	dat=i2c_read_byte();
	FT6336U_end();
	return(dat);
}

void i2c_read_addr_str(unsigned char device_addr,unsigned char read_addr,unsigned char read_amount,unsigned char *read_buf)
{
//	uchar dat;
	unsigned char i;
	FT6336U_start();
	i2c_write_byte(device_addr<<1);
	i2c_write_byte(read_addr);
	FT6336U_end();

	FT6336U_start();
	i2c_write_byte((device_addr<<1) | 0x01);

	for(i=0;i<read_amount-1;i++)
	{
		read_buf[i] = i2c_read_keep_byte();	
	}
	read_buf[i] = i2c_read_byte();
	FT6336U_end();
}


void i2c_write_addr_byte(unsigned char device_addr,unsigned char write_addr,unsigned char write_dat)
{
	FT6336U_start();
	i2c_write_byte(device_addr<<1);
	i2c_write_byte(write_addr);
	i2c_write_byte(write_dat);
	FT6336U_end();
	delay(2);
}

unsigned int i2c_read_addr_int(unsigned char device_addr,unsigned char read_addr)
{
	unsigned char read_buf[2];
	i2c_read_addr_str(device_addr,read_addr,2,read_buf);
	return (read_buf[0]<<8)|read_buf[1];
}

void i2c_write_addr_str(unsigned char device_addr,unsigned char write_addr,unsigned char write_amount,unsigned char *write_buf)
{
	unsigned char i;
	FT6336U_start();
	i2c_write_byte(device_addr<<1);
	i2c_write_byte(write_addr);
	for(i=0;i<write_amount;i++)
	{
		i2c_write_byte(write_buf[i]);
	}
	FT6336U_end();
	delay(2);
}
